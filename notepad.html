<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Notepad ‚Äî Notes</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Hide internal bottom nav if inside iframe */
        body.in-iframe .bottom-nav,
        body.in-iframe .nav-left,
        body.in-iframe #openTasks {
            display: none !important;
        }

        :root {
            --accent: #40E0D0;
            --bg: #000;
            --card-radius: 14px;
            --muted: #bfc7cc;
        }

        /* Bottom sheet overlay */
        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #0b0b0b;
            border-top: 1px solid #333;
            padding: 14px 0;
            display: none;
            flex-direction: column;
            z-index: 9999;
            animation: slideUp 0.20s ease;
        }

        .sheet-btn {
            padding: 14px 22px;
            font-size: 17px;
            color: white;
            border-bottom: 1px solid #1a1a1a;
        }

        .sheet-btn.delete {
            color: #ff6b6b;
        }

        .sheet-btn:active {
            background: rgba(255, 255, 255, 0.05);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        * {
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif
        }

        body {
            margin: 0;
            background: var(--bg);
            color: #fff;
            min-height: 100vh;
            padding-bottom: 84px
        }

        header {
            padding: 20px 16px 8px;
            display: flex;
            align-items: center;
            gap: 12px
        }

        header h1 {
            margin: 0;
            font-size: 26px;
            color: var(--accent);
            flex: 1
        }

        .search {
            background: transparent;
            border: 1px solid #222;
            padding: 8px 12px;
            border-radius: 999px;
            color: #ddd
        }

        .top-actions {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .btn {
            background: none;
            border: 1px solid #222;
            color: var(--accent);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer
        }

        .btn.primary {
            background: var(--accent);
            color: #000;
            border: none
        }

        .container {
            padding: 8px 12px
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px
        }

        .note-card {
            position: relative;
            padding: 12px;
            border-radius: var(--card-radius);
            min-height: 110px;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
            transition: transform .15s ease, box-shadow .15s ease
        }

        .note-card.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 14px 40px rgba(64, 224, 208, 0.12)
        }

        .note-card.placeholder {
            outline: 3px dashed rgba(255, 255, 255, 0.06)
        }

        .note-card:active {
            transform: translateY(2px) scale(.998)
        }

        .note-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px
        }

        .note-title {
            font-weight: 600;
            margin: 0 0 8px 0;
            font-size: 16px;
            color: rgba(0, 0, 0, 0.8)
        }

        .note-preview {
            color: rgba(0, 0, 0, 0.65);
            font-size: 13px;
            line-height: 1.3;
            white-space: pre-wrap;
            word-break: break-word
        }

        .card-actions {
            display: flex;
            gap: 8px
        }

        .icon-btn {
            background: rgba(0, 0, 0, 0.06);
            border: none;
            padding: 6px;
            border-radius: 8px;
            cursor: pointer
        }

        .pin {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .count-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px
        }

        .muted {
            color: var(--muted);
            font-weight: 500
        }

        /* create modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999
        }

        .modal {
            background: #0b0b0b;
            padding: 18px;
            border-radius: 12px;
            width: 92%;
            max-width: 420px;
            border: 1px solid #222
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #222;
            background: #070707;
            color: #ddd
        }

        .color-palette {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px
        }

        .swatch {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.06);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5)
        }

        .swatch.selected {
            outline: 3px solid rgba(255, 255, 255, 0.06);
            transform: scale(1.05)
        }

        .footer-space {
            height: 84px
        }

        /* bottom nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px 18px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.6));
            box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.6);
            z-index: 50
        }

        .nav-left {
            display: flex;
            gap: 10px
        }

        .fab {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 14px;
            border-radius: 999px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(64, 224, 208, 0.12)
        }

        /* pinned badge */
        .pinned-badge {
            background: rgba(0, 0, 0, 0.2);
            color: #fff;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px
        }

        /* empty */
        .empty {
            padding: 48px;
            text-align: center;
            color: var(--muted)
        }

        /* lock badge */
        .lock-badge {
            position: absolute;
            left: 8px;
            top: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 6px;
            border-radius: 8px
        }

        /* small helpers */
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 12px;
            color: rgba(0, 0, 0, 0.6)
        }

        @media(min-width:700px) {
            .notes-grid {
                grid-template-columns: repeat(3, 1fr)
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Notes</h1>
        <div class="top-actions">
            <input id="searchInput" class="search" placeholder="Search notes..." />
        </div>
    </header>

    <main class="container">
        <div class="controls">
            <button id="createBtn" class="btn primary">+ New Note</button>
            <div style="flex:1"></div>
            <button id="clearAll" class="btn">Clear All</button>
        </div>

        <div id="notesWrap">
            <div id="pinnedSection" style="margin-bottom:12px"></div>
            <div id="grid" class="notes-grid"></div>
            <div id="emptyState" class="empty" style="display:none">No notes yet ‚Äî create one.</div>
        </div>
    </main>

    <div class="footer-space"></div>

    <!-- Create / Edit Modal -->
    <div id="modal" class="modal-backdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <strong style="font-size:16px">Create Note</strong>
                <button id="closeModal" class="btn" style="border:0;background:none;color:var(--muted)">Close</button>
            </div>

            <div style="margin-top:6px">
                <input id="newTitle" class="input" placeholder="Note title (optional)" />
                <textarea id="newContent" class="input" rows="6" style="margin-top:8px;resize:vertical"></textarea>

                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                    <div>
                        <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Pick color</div>
                        <div id="palette" class="color-palette"></div>
                    </div>
                    <div style="width:120px;text-align:right">
                        <div style="font-size:13px;color:var(--muted)">Custom</div>
                        <input id="customColor" type="color" value="#FFD875"
                            style="width:100%;height:40px;border-radius:8px;border:0;cursor:pointer" />
                    </div>
                </div>

                <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
                    <button id="saveNoteBtn" class="btn primary">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- bottom navigation -->
    <div class="bottom-nav">
        <div class="nav-left">
            <button id="openTasks" class="btn" title="Task Page">Tasks</button>
        </div>
        <div style="display:flex;gap:8px">
            <button id="createFab" class="fab">+ Note</button>
        </div>
    </div>

    <script>
        // Detect if running inside iframe
        if (window !== window.parent) {
            document.body.classList.add("in-iframe");
        }
        /* STORAGE & HELPERS */
        const STORAGE_KEY = 'notes_v1';
        let notes = []; // array order => user order
        const paletteColors = ['#FFD875', '#FF8A80', '#FFB6C1', '#A6FFF2', '#A6D4FF', '#E6A6FF', '#FFDEB1', '#C2F0C2'];

        /* crypto helpers for encryption */
        async function deriveKey(password, saltHex) {
            const enc = new TextEncoder();
            const pwKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
            const salt = hexToBytes(saltHex);
            return crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: salt, iterations: 200000, hash: 'SHA-256' },
                pwKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }

        function bytesToHex(bytes) {
            return Array.from(new Uint8Array(bytes)).map(b => b.toString(16).padStart(2, '0')).join('');
        }
        function hexToBytes(hex) {
            const arr = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) arr[i / 2] = parseInt(hex.substr(i, 2), 16);
            return arr;
        }
        function bufToBase64(buf) {
            // convert ArrayBuffer to base64 string
            const bytes = new Uint8Array(buf);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
        function base64ToBuf(b64) {
            const bin = atob(b64);
            const len = bin.length;
            const buf = new Uint8Array(len);
            for (let i = 0; i < len; i++) buf[i] = bin.charCodeAt(i);
            return buf.buffer;
        }

        function openSheet(note) {
            const sheet = document.getElementById("actionSheet");
            sheet.style.display = "flex";

            // Dynamically update labels based on note state
            const pinBtn = document.getElementById("sheetPin");
            pinBtn.textContent = note.pinned ? "üìå Unpin" : "üìå Pin";

            const lockBtn = document.getElementById("sheetLock");
            lockBtn.textContent = note.encrypted ? "üîì Unlock" : "üîí Lock";

            // Button actions
            pinBtn.onclick = () => {
                note.pinned = !note.pinned;
                saveNotes();
                renderNotes(searchInput.value);
                hideSheet();
            };

            document.getElementById("sheetDuplicate").onclick = () => {
                const clone = { ...note, id: Date.now(), modified: Date.now(), title: (note.title || "Copy") };
                notes.unshift(clone);
                saveNotes();
                renderNotes(searchInput.value);
                hideSheet();
            };

            document.getElementById("sheetShare").onclick = () => {
                openShareMenu(note);
                hideSheet();
            };

            lockBtn.onclick = () => {
                document.querySelector('.icon-btn[title="Lock"], .icon-btn[title="Unlock"]')?.click();
                hideSheet();
            };

            document.getElementById("sheetDelete").onclick = () => {
                if (confirm("Delete this note?")) {
                    notes = notes.filter(n => n.id !== note.id);
                    saveNotes();
                    renderNotes(searchInput.value);
                }
                hideSheet();
            };
        }

        /* load/save */
        function loadNotes() {
            const raw = localStorage.getItem(STORAGE_KEY);
            notes = raw ? JSON.parse(raw) : [];
        }
        function saveNotes() { localStorage.setItem(STORAGE_KEY, JSON.stringify(notes)); }

        /* UI refs */
        const grid = document.getElementById('grid');
        const pinnedSection = document.getElementById('pinnedSection');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');

        /* rendering & helpers */
        function formatPreview(text) { if (!text) return ''; const lines = text.trim().split(/\n/).map(s => s.trim()).filter(Boolean); return (lines.slice(0, 4).join('\n')) || (text.substring(0, 80)); }

        function createCard(note) {
            const card = document.createElement('div');
            card.className = 'note-card';
            card.draggable = true;
            card.dataset.id = note.id;
            card.style.background = note.color || '#fff';
            card.style.color = '#000';

            // lock badge
            if (note.encrypted) {
                const lock = document.createElement('div');
                lock.className = 'lock-badge';
                lock.textContent = 'üîí';
                card.appendChild(lock);
            }

            let pressTimer;

            card.addEventListener("touchstart", () => {
                pressTimer = setTimeout(() => openSheet(note), 420);
            });

            card.addEventListener("touchend", () => clearTimeout(pressTimer));
            card.addEventListener("touchmove", () => clearTimeout(pressTimer));

            const top = document.createElement('div'); top.className = 'note-top';
            const title = document.createElement('h3'); title.className = 'note-title';
            title.textContent = note.title || (note.content || 'Untitled').split('\n')[0].slice(0, 30);

            top.appendChild(title);

            const preview = document.createElement('div'); preview.className = 'note-preview';
            preview.textContent = note.encrypted ? 'Encrypted note ‚Äî unlock to view.' : formatPreview(note.content);

            card.appendChild(top);
            card.appendChild(preview);

            // click opens editor, but if encrypted ask password first via editor (editor handles pw param)
            card.onclick = () => {
                window.parent.postMessage({ action: "openEditor", id: note.id }, "*");
            };

            /* drag events */
            card.addEventListener('dragstart', (e) => {
                card.classList.add('dragging');
                e.dataTransfer.setData('text/plain', String(note.id));
                // allow ghost image minimal
            });
            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                Array.from(grid.children).forEach(c => c.classList.remove('placeholder'));
            });
            card.addEventListener('dragover', (e) => {
                e.preventDefault();
                const dragging = document.querySelector('.note-card.dragging');
                if (!dragging || dragging === card) return;
                // show placeholder
                Array.from(grid.children).forEach(c => c.classList.remove('placeholder'));
                card.classList.add('placeholder');
            });
            card.addEventListener('dragleave', () => card.classList.remove('placeholder'));
            card.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggedId = Number(e.dataTransfer.getData('text/plain'));
                const targetId = note.id;
                reorderNotes(draggedId, targetId);
                Array.from(grid.children).forEach(c => c.classList.remove('placeholder'));
            });

            return card;
        }

        /* reorder logic */
        function reorderNotes(draggedId, targetId) {
            if (draggedId === targetId) return;
            const dIdx = notes.findIndex(n => n.id === draggedId);
            const tIdx = notes.findIndex(n => n.id === targetId);
            if (dIdx === -1 || tIdx === -1) return;
            // take out
            const [item] = notes.splice(dIdx, 1);
            // insert before target index
            notes.splice(tIdx, 0, item);
            saveNotes();
            renderNotes(searchInput.value);
        }

        /* main render */
        function renderNotes(filter = '') {
            grid.innerHTML = ''; pinnedSection.innerHTML = '';
            const filtered = notes.filter(n => {
                if (!filter) return true;
                const s = ((n.title || '') + ' ' + (n.content || '')).toLowerCase();
                return s.includes(filter.toLowerCase());
            });

            const pinned = filtered.filter(n => n.pinned);
            const normal = filtered.filter(n => !n.pinned);

            if (pinned.length) {
                const h = document.createElement('div'); h.style.display = 'flex'; h.style.justifyContent = 'space-between'; h.style.alignItems = 'center';
                h.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><span class="pinned-badge">Pinned</span></div>`;
                pinnedSection.appendChild(h);
                const pwrap = document.createElement('div'); pwrap.className = 'notes-grid'; pwrap.style.marginTop = '8px';
                pinned.forEach(n => pwrap.appendChild(createCard(n)));
                pinnedSection.appendChild(pwrap);
            }

            if (normal.length === 0 && pinned.length === 0) { emptyState.style.display = 'block'; } else { emptyState.style.display = 'none'; }

            normal.forEach(n => grid.appendChild(createCard(n)));
        }

        /* Share / Export functions */
        function openShareMenu(note) {
            // simple prompt offering options
            const opt = prompt('Share/export: type "share" (native), "txt", or "img" to export as PNG');
            if (!opt) return;
            const o = opt.trim().toLowerCase();
            if (o === 'share') {
                // try native share
                if (navigator.share) {
                    navigator.share({ title: note.title || 'Note', text: note.encrypted ? '(Encrypted note)' : (note.title + '\n\n' + note.content) })
                        .catch(err => alert('Share cancelled or not available.'));
                } else {
                    alert('Native share not supported in this browser; try Export as txt or img.');
                }
            } else if (o === 'txt') {
                const blob = new Blob([note.encrypted ? 'Encrypted note ‚Äî unlock to view.' : ((note.title ? note.title + '\n\n' : '') + note.content || '')], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = (note.title || 'note') + '.txt';
                document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            } else if (o === 'img') {
                exportNoteAsImage(note);
            } else {
                alert('Unknown option.');
            }
        }

        /* render note to canvas and download PNG */
        function exportNoteAsImage(note) {
            const title = note.title || '';
            const content = note.encrypted ? 'Encrypted ‚Äî unlock to view.' : note.content || '';
            // canvas sizing ‚Äî approx
            const width = 800;
            const lineHeight = 28;
            const titleHeight = title ? 60 : 0;
            const lines = (title + '\n' + content).split('\n');
            const height = Math.min(2000, Math.max(300, titleHeight + lines.length * lineHeight + 80));

            const canvas = document.createElement('canvas');
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');

            // background
            ctx.fillStyle = note.color || '#FFFFFF';
            ctx.fillRect(0, 0, width, height);

            // padding
            const pad = 40;
            ctx.fillStyle = '#000';
            ctx.textBaseline = 'top';

            // title
            ctx.font = 'bold 28px Poppins, sans-serif';
            ctx.fillStyle = '#000';
            if (title) {
                wrapText(ctx, title, pad, pad, width - pad * 2, 28);
                ctx.translate(0, 8);
            }

            // content
            ctx.font = '16px Poppins, sans-serif';
            ctx.fillStyle = '#000';
            wrapText(ctx, content, pad, pad + (title ? 60 : 0), width - pad * 2, 22);

            // download
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = (note.title || 'note') + '.png';
                document.body.appendChild(a); a.click(); a.remove();
                URL.revokeObjectURL(url);
            }, 'image/png');
        }
        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let curY = y;
            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    ctx.fillText(line, x, curY);
                    line = words[n] + ' ';
                    curY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, curY);
        }

        /* encryption helpers for UI (notebook unlock/encrypt) */
        async function encryptNoteWithPassword(note, password) {
            // derive salt, iv
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const saltHex = bytesToHex(salt);
            const ivHex = bytesToHex(iv);
            // derive key
            const key = await deriveKey(password, saltHex);
            const enc = new TextEncoder();
            const plain = JSON.stringify({ title: note.title || '', content: note.content || '' });
            const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(plain));
            note.encrypted = true;
            note.encryptedData = bufToBase64(encrypted);
            note.salt = saltHex;
            note.iv = ivHex;
            // wipe plaintext fields
            note.title = '';
            note.content = '';
            note.modified = Date.now();
        }
        async function decryptNoteWithPassword(note, password) {
            if (!note.encrypted) throw new Error('Note not encrypted');
            const key = await deriveKey(password, note.salt);
            const decryptedBuf = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: hexToBytes(note.iv) }, key, base64ToBuf(note.encryptedData));
            const dec = new TextDecoder();
            const parsed = JSON.parse(dec.decode(decryptedBuf));
            return parsed; // {title, content}
        }

        /* modal / create note behavior */
        const modal = document.getElementById('modal');
        const createBtn = document.getElementById('createBtn');
        const createFab = document.getElementById('createFab');
        const closeModal = document.getElementById('closeModal');
        const saveNoteBtn = document.getElementById('saveNoteBtn');
        const newTitle = document.getElementById('newTitle');
        const newContent = document.getElementById('newContent');
        const palette = document.getElementById('palette');
        const customColor = document.getElementById('customColor');

        let selectedColor = paletteColors[0];

        function showModal() {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            newTitle.value = ''; newContent.value = ''; selectColor(selectedColor);
        }
        function hideModal() {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        createBtn.onclick = showModal;
        createFab.onclick = showModal;
        closeModal.onclick = hideModal;

        saveNoteBtn.onclick = () => {
            const t = newTitle.value.trim();
            const c = newContent.value;
            const color = selectedColor || customColor.value;
            const note = { id: Date.now(), title: t, content: c, color: color, pinned: false, modified: Date.now(), encrypted: false };
            notes.unshift(note);
            saveNotes(); renderNotes(searchInput.value); hideModal();
        };

        /* palette UI */
        function buildPalette() {
            palette.innerHTML = '';
            paletteColors.forEach(col => {
                const s = document.createElement('div'); s.className = 'swatch'; s.style.background = col;
                s.onclick = (e) => { selectColor(col); };
                palette.appendChild(s);
            });
            selectColor(selectedColor);
        }
        function selectColor(col) {
            selectedColor = col;
            Array.from(palette.children).forEach(ch => ch.classList.toggle('selected', ch.style.backgroundColor === rgbFromHex(col)));
            customColor.value = col;
        }
        function rgbFromHex(hex) {
            const c = hex.replace('#', '');
            const r = parseInt(c.substring(0, 2), 16), g = parseInt(c.substring(2, 4), 16), b = parseInt(c.substring(4, 6), 16);
            return `rgb(${r}, ${g}, ${b})`;
        }
        customColor.oninput = () => { selectColor(customColor.value); }

        window.addEventListener("click", (e) => {
            const sheet = document.getElementById("actionSheet");
            if (sheet.style.display === "flex" && !sheet.contains(e.target)) {
                hideSheet();
            }
        });

        function hideSheet() {
            document.getElementById("actionSheet").style.display = "none";
        }

        /* other controls */
        document.getElementById('openTasks').onclick = () => { location.href = 'index.html'; };
        document.getElementById('clearAll').onclick = () => { if (confirm('Clear all notes?')) { notes = []; saveNotes(); renderNotes(); } };
        const showPinnedBtn = document.getElementById('showPinned');
        if (showPinnedBtn) {
            showPinnedBtn.onclick = () => { renderNotes(''); };
        }

        /* search */
        searchInput.oninput = () => { renderNotes(searchInput.value); };

        /* init */
        loadNotes();
        buildPalette();
        renderNotes();

        // Listen for parent postMessage requests to refresh notes without reloading the iframe
window.addEventListener('message', (event) => {
    const msg = event.data;
    if (!msg || !msg.action) return;
    if (msg.action === 'refresh') {
        // Re-load notes and re-render (keep current search filter)
        try {
            loadNotes(); // should reassign `notes` from localStorage
        } catch (e) { /* ignore parse errors */ }
        renderNotes(document.getElementById('searchInput')?.value || '');
    }
});

        /* expose utilities to console (optional) */
        window._notes = notes;

        window.addEventListener("message", (event) => {
    if (event.data?.action === "refresh") {
        loadNotes();
        renderNotes(document.getElementById("searchInput")?.value || "");
    }
});

    </script>
    <!-- Long-press Action Sheet -->
    <div id="actionSheet" class="action-sheet">
        <div class="sheet-btn" id="sheetPin">üìå Pin</div>
        <div class="sheet-btn" id="sheetDuplicate">‚éò Duplicate</div>
        <div class="sheet-btn" id="sheetShare">üîó Share</div>
        <div class="sheet-btn" id="sheetLock">üîí Lock</div>
        <div class="sheet-btn delete" id="sheetDelete">üóëÔ∏è Delete</div>
    </div>
</body>

</html>